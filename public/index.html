<html>
    <head>
        <title>QR optimizer</title>
        <!-- bootstrap crap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    </head>

    <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
        <script type="module">
            const fileSelector = document.getElementById('file-selector')
            const fileQrResult = document.getElementById('file-qr-result')
            const downloadButton = document.getElementById('download')
            const qrCanvas = document.getElementById('qrcode-canvas')
            
            import QrScanner from './libs/qr-scanner.min.js';
            QrScanner.WORKER_PATH = './libs/qr-scanner-worker.min.js';
            
            // file scanning listener
            fileSelector.addEventListener('change', event => {
                const file = fileSelector.files[0];
                if (!file) return;
                // scan qr from file
                QrScanner.scanImage(file)
                    .then(result => optimize(fileQrResult, result))
                    .catch(e => error(e || 'No QR code found.'));
                 
            });

        
            // optimize function called if the file scan was ok
            async function optimize(label, result) {
                resetPage();
                // flush errors and previous prints
                document.getElementById('error-msg').innerHTML = "";
                downloadButton.style.display = "none";
                const ctx = qrCanvas.getContext('2d');
                ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);

                label.textContent = result;
                
                var qrString;

                // debug sleep - remove it
                //await sleep(1500);
                qrString = String(fileQrResult.textContent);
                // check if the decoded qr starts with HC1:
                // not ideal because malicious qr could have the prefix string injected and still be accepted
                // better solution to use the dcc-utils to check maybe?
                if (qrString.substring(0, 4) === "HC1:"){
                    qrString = qrString.replace("HC1:", "");

                    // produce qr code from qrString, show it (?) and download it
                    var qrcode = new QRious({
                        element: qrCanvas,
                        level: 'L',
                        padding: 10,
                        size: 256,
                        value: qrString
                    });

                    document.getElementById('download').style.display = "block";
                }
                else
                    document.getElementById('error-msg').innerHTML = "this aint it chief.";
            } 

            // download listener for the donwload button
            downloadButton.addEventListener('click', function() {
                downloadCanvas(this, randomJpgName());
            }, false);

            // download the generated canvas
            // called by download button on click
            function downloadCanvas(link, filename) {
                //alert("here i am " + filename);
                link.href = qrCanvas.toDataURL();
                link.download = filename;
            }

            // generate random filename
            function randomJpgName() {
                return "QR-" + Math.round(Math.random() * 10000) + ".png";
            }

            
            // flush errors and previous prints
            function resetPage() {
                document.getElementById('error-msg').innerHTML = "";
                downloadButton.style.display = "none";

                const ctx = qrCanvas.getContext('2d');
                ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
            }
            // debug sleep function
            function sleep(ms) {
               return new Promise(resolve => setTimeout(resolve, ms));
            }

            function error(msg) {
                document.getElementById('error-msg').innerHTML = msg;
            }

        </script>

Â©
        <h1 class="display-2">DCGC optimizer</h1>

        <div class="d-flex flex-column mx-auto" style="width: 75%;">
            <div class="p-2">
                <h1 class="display-3">Scan from File:</h1>
                <input type="file" id="file-selector" class="form-control">
            </div>
            <div class="p-2">
                <small class="text-muted">Debug QR content:</small>
                <span id="file-qr-result" style="color: teal;"> </span>
                <p id="error-msg" style="color: red;"></p>
            </div>
        
            <div class="p-2">
                <canvas id="qrcode-canvas"></canvas>
                <a href="" class="btn btn-primary" style="display: none;" id="download">Download QR code</a>
            </div>
        </div>
        
        
    </body>
</html>