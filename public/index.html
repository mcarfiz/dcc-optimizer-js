<html>
    <head>
        <title>QR optimizer</title>
        <!-- bootstrap crap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        
    </head>

    <body>
        <script type="text/javascript" src="./lib/qr-code-styling.js"></script>
        <!-- build via browserify dcc.js --standalone DCC > dcc-browser.js -->
        <script type="module" src="./lib/dcc-browser.js"></script>
        
        <script type="module">
            const fileSelector = document.getElementById('file-selector')
            const fileQrResult = document.getElementById('file-qr-result')
            const downloadButton = document.getElementById('download')
            const qrCanvas = document.getElementById('qrcode-canvas')
            
            import QrScanner from './lib/qr-scanner.min.js';
            QrScanner.WORKER_PATH = './lib/qr-scanner-worker.min.js';
            
            var qrCode;

            // file scanning listener
            fileSelector.addEventListener('change', event => {
                resetPage();
                // https://blog.minhazav.dev/research/html5-qrcode.html#scan-using-file better library to read everything?
                const file = fileSelector.files[0];
                if (!file) return;
                // scan qr from file
                QrScanner.scanImage(file)
                    .then(result => optimize(fileQrResult, result))
                    .catch(e => error(e || 'No QR code found.'));
            });

        
            // optimize function called if the file scan was ok
            async function optimize(label, result) {
                var qrString = String(result);
                // decode of cose content into dcc constant
                // should be used to check rules validity TO-DO
                const dcc = await DCC.fromRaw(qrString);
                // debug print
                //alert("Payload " + toString(dcc.payload));

                // check if the decoded qr starts with HC1:
                // not ideal because malicious qr could have the prefix string injected and still be accepted
                // better solution to use the dcc-utils to check maybe?
                //if (qrString.substring(0, 4) === "HC1:"){
                if (dcc){
                    label.textContent = result;
                    
                    // debug print
                    document.getElementById('payload').innerHTML = toString(dcc.payload);
                    qrString = qrString.replace("HC1:", "");

                    // documentation: https://github.com/kozakdenys/qr-code-styling
                    // can be improved to make options be selected by user
                    qrCode = new QRCodeStyling({
                        width: 512,
                        height: 512,
                        type: "jpeg",
                        data: qrString,
                        dotsOptions: {
                            color: "#000000",
                            type: "square"
                        },
                        backgroundOptions: {
                            color: "#ffffff",
                        },
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 20
                        },
                        qrOptions: {
                            mode: "Alphanumeric",
                            errorCorrectionLevel: 'L'
                        }
                    });

                    qrCode.append(qrCanvas);
                    downloadButton.style.display = "block";
                }
                else
                    document.getElementById('error-msg').innerHTML = "Internal problems reading the QR code occurred.";
            } 

            // download listener for the donwload button
            downloadButton.addEventListener('click', function() {
                // download generated image as jpg with a random name
                qrCode.download({ name: randomJpgName(), extension: "jpeg"});
            }, false);

            // generate random filename
            function randomJpgName() {
                return "QR-" + Math.round(Math.random() * 10000 + Math.random()*1000);
            }

            // flush errors and previous prints
            function resetPage() {
                document.getElementById('error-msg').innerHTML = "";
                downloadButton.style.display = "none";
                fileQrResult.innerHTML = "";
                qrCanvas.innerHTML = "";
                document.getElementById('payload').innerHTML = "";
            }

            function error(msg) {
                document.getElementById('error-msg').innerHTML = msg;
            }

            // correctly print json as a string
            // otherwise only object [object] is printed
            function toString(object) {
                return JSON.stringify(object, null, 4);
            }

        </script>

        <!-- Image and text -->
        <nav class="navbar navbar-dark bg-primary">
            <a class="navbar-brand" href="./index.html">
                <img src="./img/nav.png" width="30" height="30" class="d-inline-block align-top" alt="">
                DGCC QR optimizer
            </a>
        </nav>

        <!-- <h1 class="display-2"></h1> -->

        <div class="rowd-flex flex-column mx-auto" style="width: 85%;">
            <div class="row p-2">
                <h1 class="display-3">Scan from File:</h1>
                <div class="input-group input-group-lg flex-wrap">
                    <input type="file" id="file-selector" class="form-control">
                </div>
                
                
            </div>
            <div class="row p-2">
                <small class="text-muted">Debug QR content:</small>
                <div id="file-qr-result" style="color: teal;"> </div>
                <small class="text-muted">Payload:</small>
                <p id="payload" style="color: darkorchid;"></p>
                <p id="error-msg" style="color: red;"></p>
            </div>
        
            <div class="row p-2">
                <div class="max-vw-50" id="qrcode-canvas"></div>
            </div>
            <div>
                <input type="button" class="btn btn-primary" style="display: none;" id="download" value="Download QR code">
            </div>
            
        </div>
        
        
    </body>
</html>